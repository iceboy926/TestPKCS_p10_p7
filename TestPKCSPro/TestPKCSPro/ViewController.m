//
//  ViewController.m
//  TestPKCSPro
//
//  Created by zuoyongyong on 2017/6/5.
//  Copyright © 2017年 zuoyongyong. All rights reserved.
//

#import "ViewController.h"
#import "pkcs10Pack.h"
#import "Pkcs7Pack.h"

@interface ViewController ()

@end

@implementation ViewController

static unsigned char replaced_userPubKey[65] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0x00
};

static unsigned char cert_pub[64] = {
    0x44, 0x46, 0xd0, 0x41, 0x32, 0x80, 0xb5, 0x95,
    0x82, 0xab, 0xea, 0xab, 0x87, 0xf5, 0x6b, 0xa4,
    0xbd, 0x87, 0xdc, 0xc7, 0xa4, 0x7a, 0xf0, 0xaf,
    0x49, 0x76, 0x07, 0xc6, 0xbf, 0x1a, 0x5d, 0x4d,
    0x44, 0x46, 0xd0, 0x41, 0x32, 0x80, 0xb5, 0x95,
    0x82, 0xab, 0xea, 0xab, 0x87, 0xf5, 0x6b, 0xa4,
    0xbd, 0x87, 0xdc, 0xc7, 0xa4, 0x7a, 0xf0, 0xaf,
    0x49, 0x76, 0x07, 0xc6, 0xbf, 0x1a, 0x5d, 0x4d
};

static unsigned char cert_sign[64] = {
    0x44, 0x46, 0xd0, 0x41, 0x32, 0x80, 0xb5, 0x95,
    0x82, 0xab, 0xea, 0xab, 0x87, 0xf5, 0x6b, 0xa4,
    0xbd, 0x87, 0xdc, 0xc7, 0xa4, 0x7a, 0xf0, 0xaf,
    0x49, 0x76, 0x07, 0xc6, 0xbf, 0x1a, 0x5d, 0x4d,
    0x44, 0x46, 0xd0, 0x41, 0x32, 0x80, 0xb5, 0x95,
    0x82, 0xab, 0xea, 0xab, 0x87, 0xf5, 0x6b, 0xa4,
    0xbd, 0x87, 0xdc, 0xc7, 0xa4, 0x7a, 0xf0, 0xaf,
    0x49, 0x76, 0x07, 0xc6, 0xbf, 0x1a, 0x5d, 0x4d
};

static unsigned char plain_text[32] = {
    0x44, 0x46, 0xd0, 0x41, 0x32, 0x80, 0xb5, 0x95,
    0x82, 0xab, 0xea, 0xab, 0x87, 0xf5, 0x6b, 0xa4,
    0xbd, 0x87, 0xdc, 0xc7, 0xa4, 0x7a, 0xf0, 0xaf,
    0x49, 0x76, 0x07, 0xc6, 0xbf, 0x1a, 0x5d, 0x4d

};

unsigned char cert_text[521]={
    0x30,0x82,0x02,0x05,0x30,0x82,0x01,0xAB,0x02,0x02,0x00,0xC3,0x30,0x0A,0x06,0x08,
    0x2A,0x86,0x48,0xCE,0x3D,0x04,0x03,0x02,0x30,0x81,0x8C,0x31,0x0B,0x30,0x09,0x06,
    0x03,0x55,0x04,0x06,0x13,0x02,0x43,0x4E,0x31,0x10,0x30,0x0E,0x06,0x03,0x55,0x04,
    0x08,0x0C,0x07,0x42,0x65,0x69,0x6A,0x69,0x6E,0x67,0x31,0x10,0x30,0x0E,0x06,0x03,
    0x55,0x04,0x07,0x0C,0x07,0x42,0x65,0x69,0x6A,0x69,0x6E,0x67,0x31,0x16,0x30,0x14,
    0x06,0x03,0x55,0x04,0x0A,0x0C,0x0D,0x6E,0x6F,0x6B,0x6E,0x6F,0x6B,0x6C,0x61,0x62,
    0x73,0x2E,0x63,0x6E,0x31,0x0C,0x30,0x0A,0x06,0x03,0x55,0x04,0x0B,0x0C,0x03,0x52,
    0x26,0x44,0x31,0x10,0x30,0x0E,0x06,0x03,0x55,0x04,0x03,0x0C,0x07,0x52,0x6F,0x63,
    0x6B,0x20,0x43,0x41,0x31,0x21,0x30,0x1F,0x06,0x09,0x2A,0x86,0x48,0x86,0xF7,0x0D,
    0x01,0x09,0x01,0x16,0x12,0x78,0x75,0x65,0x68,0x61,0x6E,0x32,0x40,0x6C,0x65,0x6E,
    0x6F,0x76,0x6F,0x2E,0x63,0x6F,0x6D,0x30,0x1E,0x17,0x0D,0x31,0x37,0x30,0x35,0x32,
    0x34,0x30,0x32,0x34,0x31,0x34,0x37,0x5A,0x17,0x0D,0x32,0x37,0x30,0x35,0x32,0x32,
    0x30,0x32,0x34,0x31,0x34,0x37,0x5A,0x30,0x81,0x8E,0x31,0x0B,0x30,0x09,0x06,0x03,
    0x55,0x04,0x06,0x13,0x02,0x43,0x4E,0x31,0x10,0x30,0x0E,0x06,0x03,0x55,0x04,0x08,
    0x0C,0x07,0x42,0x65,0x69,0x6A,0x69,0x6E,0x67,0x31,0x10,0x30,0x0E,0x06,0x03,0x55,
    0x04,0x07,0x0C,0x07,0x42,0x65,0x69,0x6A,0x69,0x6E,0x67,0x31,0x16,0x30,0x14,0x06,
    0x03,0x55,0x04,0x0A,0x0C,0x0D,0x6E,0x6F,0x6B,0x6E,0x6F,0x6B,0x6C,0x61,0x62,0x73,
    0x2E,0x63,0x6E,0x31,0x0C,0x30,0x0A,0x06,0x03,0x55,0x04,0x0B,0x0C,0x03,0x52,0x26,
    0x44,0x31,0x12,0x30,0x10,0x06,0x03,0x55,0x04,0x03,0x0C,0x09,0x32,0x45,0x38,0x34,
    0x23,0x31,0x37,0x38,0x39,0x31,0x21,0x30,0x1F,0x06,0x09,0x2A,0x86,0x48,0x86,0xF7,
    0x0D,0x01,0x09,0x01,0x16,0x12,0x78,0x75,0x65,0x68,0x61,0x6E,0x32,0x40,0x6C,0x65,
    0x6E,0x6F,0x76,0x6F,0x2E,0x63,0x6F,0x6D,0x30,0x59,0x30,0x13,0x06,0x07,0x2A,0x86,
    0x48,0xCE,0x3D,0x02,0x01,0x06,0x08,0x2A,0x86,0x48,0xCE,0x3D,0x03,0x01,0x07,0x03,
    0x42,0x00,0x04,0x5F,0x3A,0x60,0x2D,0x5D,0x95,0x5F,0x2F,0xF8,0xBD,0x8E,0xF8,0x6F,
    0x56,0x10,0x04,0x33,0x02,0x92,0xF3,0x13,0x5D,0x57,0x25,0x60,0xFB,0x21,0x29,0x0C,
    0xBD,0x3E,0x59,0xF2,0x1F,0x72,0xEF,0xC4,0x19,0x01,0x42,0x4D,0xBC,0xE5,0xAB,0xD9,
    0x35,0xA0,0x8C,0xF6,0x52,0x04,0x54,0x9D,0xC4,0xD2,0xFD,0x6C,0x96,0xE6,0x30,0x47,
    0xA0,0x52,0x9C,0x30,0x0A,0x06,0x08,0x2A,0x86,0x48,0xCE,0x3D,0x04,0x03,0x02,0x03,
    0x48,0x00,0x30,0x45,0x02,0x20,0x74,0x5F,0x3F,0x1E,0x8E,0x0C,0x38,0x20,0xCB,0x21,
    0xB4,0xB9,0x26,0x62,0x30,0xA0,0x61,0xED,0x83,0x07,0x7E,0x9F,0x71,0x03,0xDA,0x09,
    0xBA,0x4C,0xBD,0x1B,0x94,0x5E,0x02,0x21,0x00,0xA2,0xFB,0xCA,0x01,0xBD,0x98,0xE2,
    0x11,0x4C,0xAF,0x55,0xF3,0xDC,0x9E,0x97,0x5C,0x23,0x36,0x5B,0x34,0xB0,0x03,0x58,
    0x93,0xA4,0xDC,0x46,0x91,0x62,0xE3,0x44,0xF2,
};



void str_replace(char * cp, int n, char * str, int len)
{
    int lenofstr = len;
    int i;
    char * tmp;
    //str3比str2短，往前移动
    if(lenofstr < n)
    {
        tmp = cp+n;
        while(*tmp)
        {
            *(tmp-(n-lenofstr)) = *tmp; //n-lenofstr是移动的距离
            tmp++;
        }
        *(tmp-(n-lenofstr)) = *tmp; //move '\0'
    }
    else
        //str3比str2长，往后移动
        if(lenofstr > n)
        {
            tmp = cp;
            while(*tmp) tmp++;
            while(tmp>=cp+n)
            {
                *(tmp+(lenofstr-n)) = *tmp;
                tmp--;
            }
        }
    memcpy(cp,str,lenofstr);
}

char *mystrstr(char *s1, int s1len,char *s2, int s2len)
{
    int n;
    int i = 0;
    if (*s2)                      //两种情况考虑
    {
        while(i < s1len)
        {
            for (n=0;*(s1+n)==*(s2+n);n++)
            {
                if (!*(s2+n+1))            //查找的下一个字符是否为'\0'
                {
                    return (char*)s1;
                }  
            }  
            s1++;
            i++;
        }  
        return NULL;  
    }  
    else  
    {  
        return (char*)s1;  
    }  
}

- (void)testencode
{
    
    DWORD dwRet = 0;
    
    //DWORD dwRet = berEncodeSubjectName(berSubjectName, &dwberSubjectNameLen, cndata, cndata_len, odata, odata_len, oudata, oudata_len, cdata, cdata_len, emaildata, emaildata_len);
    
    if(dwRet == ERROR_SUCCESS)
    {
        NSLog(@"encodeSubjectName SUCCESS");
    }
    else
    {
        NSLog(@"encodeSubjectName Failed");
    }

}

- (void)generatep10
{
    BYTE berCertReq[1024] = {0};
    DWORD dwberCertReq = sizeof(berCertReq);
    
    DWORD dwRet = PackPKCS10(cert_pub, sizeof(cert_pub), cert_sign, sizeof(cert_sign), berCertReq, &dwberCertReq);
    if(dwRet == 0)
    {
        NSLog(@"success");
    }
    else
    {
        NSLog(@"error");
    }
    
}

- (void)generatep7
{
    NSString*filePath=[[[NSBundle mainBundle] resourcePath] stringByAppendingPathComponent:@"der.cer"];
    NSError *err;
    
    NSString* mTxt=[NSString stringWithContentsOfFile:filePath encoding:NSUTF8StringEncoding error:&err];
    
    NSData *data = [NSData dataWithContentsOfFile:filePath];
    NSLog(@"NSData类方法读取的内容是：%@",[[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding]);
}

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view, typically from a nib.
    
   NSString *strIn = @"1.2.156.10197.1.501";  //sm2-sm3sign
    
   NSString *strIn1 = @"2.5.29.15";
    
   // [self getTestOut:strIn1];
    
    //[self generatep10];
    
    [self generatep7];
 
}

void convertData(int intData, int N, char *szoutdata, int *poutdatalen)
{
    int temp = intData;
    char szout[128] = {0};
    int count = 0;
    int remainder = 0;
    int j = 0;

    
    while(temp)
    {
        remainder = temp % N;
        szout[j++] = remainder;
        temp = temp/N;
    }
    
    *poutdatalen = j;
    
    for(int i = 0; i < j; i++)
    {
        if(i == j-1)
        {
            szoutdata[i] = szout[j-i-1];
        }
        else
        {
            szoutdata[i] = szout[j-i-1]|0x80;
        }
    }
}

- (void)getTestOut:(NSString *)strin
{
    NSString *strOut = [NSString string];
    NSMutableArray *strArray = [NSMutableArray array];
    char szOutData[128] = {0};
    int outdataLen = 0;
    
    NSArray *arrayOut = [strin componentsSeparatedByString:@"."];
    
    NSString *strV1 = [arrayOut objectAtIndex:0];
    NSString *strV2 = [arrayOut objectAtIndex:1];
    
    szOutData[0] = 40*[strV1 intValue] + [strV2 intValue];
    
    [strArray addObject:[NSString stringWithFormat:@"0x%x", szOutData[0]]];

    
    for (int i = 2; i < [arrayOut count]; i++) {
        
        int value = [[arrayOut objectAtIndex:i] intValue];
        
        char szOutData[128] = {0};
        int len = 0;
        
        convertData(value, 128, szOutData, &len);
        
        for (int j = 0; j < len; j++) {
            
            int intValue = szOutData[j];
            [strArray addObject:[NSString stringWithFormat:@"0x%x", intValue]];
        }
    }
    
    
    NSLog(@"strArray is %@", strArray);
    
    
    return ;
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}


@end
